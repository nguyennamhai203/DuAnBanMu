@model IEnumerable<Shop_Models.Entities.Voucher>
@using Shop_Models.Entities;

@{
    ViewData["Title"] = "Index";
    var voucher = (ViewData["Voucher"] as List<Voucher>);
}

<div class="pagetitle">
    <h1>Quản lý Voucher</h1>
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li class="breadcrumb-item active">Tổng quan</li>
            <li class="breadcrumb-item active">Voucher</li>
        </ol>
    </nav>
</div>
<!-- End Page Title -->

<section class="section dashboard">
    <div class="row">
        <!-- Left side columns -->
        <div class="col-lg-8">
            <div class="row">
                <!-- Recent Sales -->
                <div class="col-12">
                    <div class="card recent-sales overflow-auto">
                        <div id="tableInfo" class="card-body">
                            <table id="tableBody" class="table table-hover datatable">
                                <thead>
                                    <tr>
                                        <th>Mã</th>
                                        <th>Tên</th>
                                        <th>Phần Trăm Giảm</th>
                                        <th>Số Lượng</th>
                                        <th>Ngày Bắt Đầu</th>
                                        <th>Ngày Kết Thúc</th>
                                        <th>Trạng Thái</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in @Model)
                                    {
                                        <tr>
                                            <td>@item.MaVoucher</td>
                                            <td>@item.TenVoucher</td>
                                            <td>@item.PhanTramGiam</td>
                                            <td>@item.SoLuong</td>
                                            <td>@item.NgayBatDau.Value.Day/@item.NgayBatDau.Value.Month/@item.NgayBatDau.Value.Year</td>
                                            <td>@item.NgayHetHan.Value.Day/@item.NgayHetHan.Value.Month/@item.NgayHetHan.Value.Year</td>
                                            <td>
                                                @if (item.TrangThai == 0)
                                                {
                                                    <span>Hoạt Động</span>
                                                }
                                                else
                                                {
                                                    <span>Hết Hạn</span>
                                                }
                                            </td>
                                            <td>
                                                <a asp-area="Admin" asp-controller="Voucher" asp-action="Detail" asp-route-id="@item.Guid" class="btn btn-success" title="Chi tiết" style="margin-right: 10px;">
                                                    <i class="bx bxs-detail"></i>
                                                </a>
                                                <a class="btn btn-danger" onclick="deleteForm('@item.Guid')" title="Xóa">
                                                    <i class="bx bxs-trash-alt"></i>
                                                </a>
                                            </td>

                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- End Recent Sales -->
            </div>

        </div><!-- End Left side columns -->
        <!-- Right side columns -->
        <div class="col-lg-4">

            <!-- Recent Activity -->
            <div class="card">

                <div class="card-body">
                    <h5 class="card-title">Quản lý <span>| xx</span></h5>
                    <!-- Default Tabs -->
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="contact-tab" data-bs-toggle="tab"
                                    data-bs-target="#contact" type="button" role="tab" aria-controls="contact"
                                    aria-selected="false">
                                Chi tiết
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link " id="home-tab" data-bs-toggle="tab"
                                    data-bs-target="#home" type="button" role="tab" aria-controls="home"
                                    aria-selected="true">
                                Cập nhật
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profile-tab" data-bs-toggle="tab"
                                    data-bs-target="#profile" type="button" role="tab" aria-controls="profile"
                                    aria-selected="false">
                                Tạo mới
                            </button>
                        </li>
                    </ul>

                    @* Update *@
                    <div class="tab-content pt-2" id="myTabContent">
                        <div class="tab-pane fade" id="home" role="tabpanel"
                             aria-labelledby="home-tab">
                            @if (voucher != null)
                            {
                                <form id="updateProfileForm">
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Mã</label>
                                        <div class="col-sm-8">
                                            <input asp-for="@voucher.First().MaVoucher" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Tên</label>
                                        <div class="col-sm-8">
                                            <input asp-for="@voucher.First().TenVoucher" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Tỉ Lệ</label>
                                        <div class="col-sm-8">
                                            <input asp-for="@voucher.First().PhanTramGiam" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Số Lượng</label>
                                        <div class="col-sm-8">
                                            <input asp-for="@voucher.First().SoLuong" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Ngày Bắt Đầu</label>
                                        <div class="col-sm-8">
                                            <input asp-for="@voucher.First().NgayBatDau" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Ngày Kết Thúc</label>
                                        <div class="col-sm-8">
                                            <input asp-for="@voucher.First().NgayHetHan" type="text" class="form-control" />
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label">Trạng Thái</label>
                                        <div class="col-sm-8">

                                            <select asp-for="@voucher.First().TrangThai" class="form-select" aria-label="Default select example">
                                                @if (voucher.First().TrangThai == 0)
                                                {
                                                    <option value="0" selected>Đang Hoạt Động</option>
                                                    <option value="1">Đã Hết Hạn</option>
                                                }
                                                else
                                                {
                                                    <option value="0">Đang Hoạt Động</option>
                                                    <option value="1" selected>Đã Hết Hạn</option>
                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-warning" onclick="updateForm()">Lưu</button>
                                </form>
                            }
                        </div>

                        @* Create *@
                        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                            <form id="createProfileForm">
                                <div class="mb-3 row">
                                    <label class="col-sm-4 col-form-label">Mã</label>
                                    <div class="col-sm-8">
                                        <input id="MaVoucher" name="MaVoucher" type="text" class="form-control" />
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-4 col-form-label">Tên</label>
                                    <div class="col-sm-8">
                                        <input id="TenVoucher" name="TenVoucher" type="text" class="form-control" />
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-4 col-form-label">Tỉ Lệ</label>
                                    <div class="col-sm-8">
                                        <input id="PhanTramGiam" name="PhanTramGiam" type="text" class="form-control" />
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-4 col-form-label">Sô Lượng</label>
                                    <div class="col-sm-8">
                                        <input id="SoLuong" name="SoLuong" type="number" class="form-control" />
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-4 col-form-label">Ngày Bắt Đầu</label>
                                    <div class="col-sm-8">
                                        <input id="NgayBatDau" name="NgayBatDau" type="date" class="form-control" />
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-4 col-form-label">Ngày Kết Thúc</label>
                                    <div class="col-sm-8">
                                        <input id="NgayHetHan" name="NgayHetHan" type="date" class="form-control" />
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success" onclick="saveForm()">Thêm</button>
                            </form><!-- End Multi Columns Form -->
                        </div>

                        @* Detail *@
                        <div class="tab-pane fade show active" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                            @if (voucher != null)
                            {
                                <div class="row">
                                    <label class="col-sm-4 col-form-label">
                                        <p>Mã</p>
                                        <p>Tên</p>
                                        <p>Tỉ Lệ</p>
                                        <p>Số Lượng</p>
                                        <p>Ngày tạo</p>
                                        <p>Ngày sửa</p>
                                        <span>Trạng thái</span>
                                    </label>
                                    <label class="col-sm-8 col-form-label">
                                        @foreach (var item in voucher)
                                        {
                                            <p>@item.MaVoucher</p>
                                            <p>@item.TenVoucher</p>
                                            <p>@item.PhanTramGiam</p>
                                            <p>@item.SoLuong</p>
                                            <p>@item.NgayBatDau</p>
                                            <p>@item.NgayHetHan</p>
                                            @if (item.TrangThai == 0)
                                            {
                                                <span>Đang Hoạt Động</span>
                                            }
                                            else
                                            {
                                                <span>Đã Hết Hạn</span>
                                            }
                                        }
                                    </label>
                                </div>
                            }
                        </div>
                    </div><!-- End Default Tabs -->

                </div>

            </div>
        </div><!-- End Recent Activity -->

    </div><!-- End Right side columns -->

</section>

<script>

    // Function hiển thị thông báo
    function showNotification(message, type) {
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right", // Sửa từ "toast-top-right" thành "toast-bottom-right"
            "preventDuplicates": true,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        // Hiển thị thông báo theo loại
        if (type === "success") {
            toastr.success(message);
        } else {
            toastr.error(message);
        }
    }

    function saveForm(event) {
        // Ngăn chặn hành động mặc định của nút submit
        event.preventDefault();

        // Lấy ra các giá trị từ các trường trong form
        var parentElement = document.getElementById('createProfileForm');
        var maVoucher = parentElement.querySelector('#MaVoucher').value;
        var tenVoucher = parentElement.querySelector('#TenVoucher').value;
        var phanTramGiam = parentElement.querySelector('#PhanTramGiam').value;
        var soLuong = parentElement.querySelector('#SoLuong').value;
        var ngayBatDau = parentElement.querySelector('#NgayBatDau').value;
        var ngayHetHan = parentElement.querySelector('#NgayHetHan').value;

        // Kiểm tra xem các trường có bị bỏ trống không
        if (!maVoucher || !tenVoucher || !phanTramGiam || !soLuong || !ngayBatDau || !ngayHetHan) {
            // Hiển thị thông báo lỗi nếu có trường nào bị bỏ trống
            showNotification("Vui lòng điền đầy đủ thông tin vào các trường", "warning");
            return; // Ngăn không cho tiếp tục thực hiện lưu form
        }

        // Kiểm tra ngày hết hạn phải sau ngày bắt đầu
        if (new Date(ngayHetHan) <= new Date(ngayBatDau)) {
            showNotification("Ngày hết hạn phải sau ngày bắt đầu", "warning");
            return;
        }

        // Nếu các trường đều được điền đầy đủ, tiếp tục xác nhận thêm bản ghi
        var formData = new FormData(document.getElementById('createProfileForm'));

        Swal.fire({
            title: 'Xác nhận',
            text: 'Bạn có chắc chắn muốn thêm bản ghi này ?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Có',
            cancelButtonText: 'Không'
        }).then((result) => {
            if (result.isConfirmed) {
                performRequest(formData);
            } else {
                // Người dùng huỷ bỏ, không làm gì cả
                // Swal.fire('Cancelled', 'Your action has been cancelled', 'info');
            }
        });
    }

    function performRequest(formData) {
        $.ajax({
            url: '/Voucher/Create',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (results) {
                // Hiển thị thông báo thành công
                showNotification("Thêm bản ghi thành công", "success");
                updateTable();
                document.getElementById('createProfileForm').reset();
            },
            error: function () {
                // Hiển thị thông báo lỗi
                showNotification("Đã xảy ra lỗi khi thêm bản ghi", "error");
            }
        });
    }

    // Lắng nghe sự kiện submit của biểu mẫu và gọi hàm saveForm
    document.getElementById('createProfileForm').addEventListener('submit', saveForm);

    function updateForm() {
        var formData = new FormData(document.getElementById('updateProfileForm'));

        Swal.fire({
            title: 'Xác nhận',
            text: 'Bạn có chắc chắn muốn Cập nhật bản ghi này ?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Có',
            cancelButtonText: 'Không'
        }).then((result) => {
            if (result.isConfirmed) {
                // User confirmed, perform the request
                performUpdateRequest(formData);
            } else {
                // User canceled, do nothing
                // Swal.fire('Cancelled', 'Your action has been cancelled', 'info');
            }
        });

        event.preventDefault(); // Di chuyển lệnh này xuống phía dưới

    }

    function performUpdateRequest(formData) {
        var guid = "@(voucher?.Any() == true ? voucher.First().Guid.ToString() : Guid.Empty.ToString())";
        $.ajax({
            url: '/Voucher/Update?id=' + guid,
            type: 'PUT',
            data: formData,
            contentType: false,
            processData: false,
            success: function (results) {
                showNotification("Cập nhật thành công", "success");
                document.getElementById('updateProfileForm').reset();

                updateTable();
            },
            error: function () {
                showNotification("Lỗi hệ thống", "error");
            }
        });
    }

    function deleteForm(id) {
        Swal.fire({
            title: 'Xác nhận',
            text: 'Bạn có chắc chắn muốn Xóa bản ghi này ?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Có',
            cancelButtonText: 'Không'
        }).then((result) => {
            if (result.isConfirmed) {
                // User confirmed, perform the request
                performDeleteRequest(id);
            } else {
                // User canceled, do nothing
                // Swal.fire('Cancelled', 'Your action has been cancelled', 'info');
            }
        });

        return false; // Return false to prevent the default behavior of the anchor tag
    }

    function performDeleteRequest(id) {
        $.ajax({
            url: '/Voucher/Delete?id=' + id,
            type: 'DELETE',
            contentType: 'application/json',
            success: function (results) {
                if (results.success) {
                    showNotification("Xóa thành công", "success");
                    updateTable(); // Update the table after successful deletion
                } else {
                    showNotification("Không thể xóa bản ghi", "error");
                }
            },
            error: function () {
                showNotification("Lỗi hệ thống", "error");
            }
        });
    }

    function showNotification(message, type) {
        // Implement your notification logic here (e.g., using SweetAlert)
        Swal.fire({
            title: message,
            icon: type
        });
    }

    function updateTable() {
        $.ajax({
            url: '/Voucher/GetAllVoucher',
            type: 'GET',
            success: function (data) {
                var table = $('#tableBody');
                table.empty(); // Xóa toàn bộ nội dung của bảng

                // Khởi tạo lại bảng với dữ liệu mới
                var newTable = '<table id="dataTable" class="table table-hover">' +
                    '<thead>' +
                    '<tr>' +
                    '<th>Mã</th>' +
                    '<th>Tên</th>' +
                    '<th>Phần Trăm Giảm</th>' +
                    '<th>Số Lượng</th>' +
                    '<th>Ngày Bắt Đầu</th>' +
                    '<th>Ngày Kết Thúc</th>' +
                    '<th>Trạng thái</th>' +
                    '<th></th>' +
                    '</tr>' +
                    '</thead>' +
                    '<tbody>';
                if (data && data.length > 0) {
                    data.forEach(function (item) {
                        var newRow = '<tr>' +
                            '<td>' + item.maVoucher + '</td>' +
                            '<td>' + item.tenVoucher + '</td>' +
                            '<td>' + item.phanTramGiam + '</td>' +
                            '<td>' + item.soLuong + '</td>' +
                            '<td>' + item.ngayBatDau  + '</td>' +
                            '<td>' + item.ngayHetHan + '</td>' +
                            '<td>' + (item.trangThai === 0 ? 'Hoạt Động' : 'Hết Hạn') + '</td>' +
                            '<td>' +
                            '<a href="/Voucher/Index/' + item.guid + '" class="btn btn-success" title="Chi tiết" style="margin-right: 10px;">' +
                            '<i class="bx bxs-detail"></i>' +
                            '</a>' +
                            '<a id="deleteProfileForm" class="btn btn-danger" onclick="deleteForm(\'' + item.guid + '\')" title="Xóa">' +
                            '<i class="bx bxs-trash-alt"></i>' +
                            '</a>' +
                            '</td>' +
                            '</tr>';
                        newTable += newRow;
                    });
                } else {
                    // Nếu không có dữ liệu, hiển thị thông báo
                    newTable += '<tr><td colspan="3">No data available</td></tr>';
                }

                newTable += '</tbody></table>';

                table.append(newTable);

                // Khởi tạo lại DataTables cho bảng mới
                $('#dataTable').DataTable({
                    // Các cài đặt DataTables, bao gồm cài đặt phân trang
                    "paging": true,
                    // Các cài đặt khác...
                });
                $('.datatable-top').remove();
                $('.datatable-bottom').remove();
            },
            error: function (xhr, status, error) {
                // Xử lý lỗi AJAX
                console.log(xhr.responseText); // Ghi log phản hồi lỗi
                showNotification("Lỗi khi tải dữ liệu bảng", "error");
            }
        });
    }

</script>